{% from "sensu/map.jinja" import sensu with context %}
{

{% if salt['pillar.get']('sensu:hipchat_apikey', False) -%}
  "hipchat": {
    "apikey": "{{ sensu.hipchat_apikey }}"
    "room": "{{ sensu.hipchat_roomname }}"
  },
{% endif -%}
 
{% if salt['pillar.get']('sensu:pagerduty_apikey', False) -%}
  "pagerduty": {
    "api_key": "{{ sensu.pagerduty_apikey }}"
  },
{% endif -%}
 
  "handlers": {
    "default": {
      "type": "set",
      "handlers": [
{%- if salt['pillar.get']('sensu:hipchat_apikey', False) %}
        "hipchat",
{% endif -%}
{% if salt['pillar.get']('sensu:pagerduty_apikey', False) -%}
        "pagerduty",
{% endif -%}
        "stdout", "email"
      ]
    },
    "stdout": {
      "type": "pipe",
      "command": "cat"
    },
{% if salt['pillar.get']('sensu:pagerduty_apikey', False) -%}
    "pagerduty": {
      "command": "/etc/sensu/community/handlers/notification/pagerduty.rb",
      "type": "pipe"
    },
{% endif -%}
{% if salt['pillar.get']('sensu:hipchat_apikey', False) -%}
    "pagerduty": {
      "command": "/etc/sensu/community/handlers/notification/hipchat.rb",
      "type": "pipe"
    },
{% endif -%}
    "email": {
      "type": "pipe",
      "command": "mail -s '[sensu] alert' {{sensu.email}}"
    }
  }
}

